<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="All-forks header and body syncing."><title>smoldot::sync::all_forks - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../../static.files/rustdoc-84e720fa.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="smoldot" data-themes="" data-resource-suffix="" data-rustdoc-version="1.89.0 (29483883e 2025-08-04)" data-channel="1.89.0" data-search-js="search-92309212.js" data-settings-js="settings-5514c975.js" ><script src="../../../static.files/storage-4e99c027.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-fd3af306.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-32bb7600.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-044be391.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../smoldot/index.html">smoldot</a><span class="version">0.19.4</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module all_<wbr>forks</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#overview" title="Overview">Overview</a></li><li><a href="#bounded-and-unbounded-containers" title="Bounded and unbounded containers">Bounded and unbounded containers</a></li></ul><h3><a href="#reexports">Module Items</a></h3><ul class="block"><li><a href="#reexports" title="Re-exports">Re-exports</a></li><li><a href="#modules" title="Modules">Modules</a></li><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#enums" title="Enums">Enums</a></li></ul></section><div id="rustdoc-modnav"><h2><a href="../index.html">In smoldot::<wbr>sync</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../../index.html">smoldot</a>::<wbr><a href="../index.html">sync</a></div><h1>Module <span>all_forks</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/smoldot/sync/all_forks.rs.html#18-2387">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p><em>All-forks</em> header and body syncing.</p>
<h2 id="overview"><a class="doc-anchor" href="#overview">§</a>Overview</h2>
<p>This state machine holds:</p>
<ul>
<li>A list of sources of blocks, maintained by the API user.</li>
<li>For each source, a list of blocks hashes known by the source.</li>
<li>The latest known finalized block.</li>
<li>A tree of valid non-finalized blocks that all descend from the latest known finalized block.</li>
<li>(if full mode) A list of block headers whose body is currently being downloaded.</li>
<li>A list of block header waiting to be verified and whose ancestry with the latest finalized
block is currently unknown.</li>
</ul>
<p>The state machine has the objective to synchronize the tree of non-finalized blocks with its
equivalent on the sources added by the API user.</p>
<p>Because it is not possible to predict which block in this tree is going to be finalized in
the future, the entire tree needs to be synchronized.</p>
<blockquote>
<p><strong>Example</strong>: If the latest finalized block is block number 4, and the tree contains blocks
5, 6, and 7, and a source announces a block 5 that is different from the
locally-known block 5, a block request will be emitted for this block 5, even
if it is certain that this “other” block 5 will not become the local best
block. This is necessary in case it is this other block 5 that will end up
being finalized.</p>
</blockquote>
<h2 id="bounded-and-unbounded-containers"><a class="doc-anchor" href="#bounded-and-unbounded-containers">§</a>Bounded and unbounded containers</h2>
<p>It is important to limit the memory usage of this state machine no matter how the
potentially-malicious sources behave.</p>
<p>The state in this state machine can be put into three categories:</p>
<ul>
<li>
<p>Each source of blocks has a certain fixed-size state associated to it (containing for
instance its best block number and height). Each source also has up to one in-flight
request, which might incur more memory usage. Managing this additional request is out of
scope of this module. The user of this module is expected to limit the number of
simultaneous sources.</p>
</li>
<li>
<p>A set of verified blocks that descend from the latest finalized block. This set is
unbounded. The consensus and finalization algorithms of the chain are supposed to limit
the number of possible blocks in this set.</p>
</li>
<li>
<p>A set of blocks that can’t be verified yet. Receiving a block announce inserts an element
in this set. In order to handle situations where a malicious source announces lots of
invalid blocks, this set must be bounded. Once it has reached a certain size, the blocks
with the highest block number are discarded if their parent is also in this set or being
downloaded from a source.</p>
</li>
</ul>
<p>Consequently, and assuming that the number of simultaneous sources is bounded, and that
the consensus and finalization algorithms of the chain are properly configured, malicious
sources can’t indefinitely grow the state in this state machine.
Malicious sources, however, can potentially increase the number of block requests required to
download a long fork. This is, at most, an annoyance, and not a vulnerability.</p>
</div></details><h2 id="reexports" class="section-header">Re-exports<a href="#reexports" class="anchor">§</a></h2><dl class="item-table reexports"><dt id="reexport.SourceId"><code>pub use pending_blocks::<a class="struct" href="sources/struct.SourceId.html" title="struct smoldot::sync::all_forks::sources::SourceId">SourceId</a>;</code></dt></dl><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><dl class="item-table"><dt><a class="mod" href="sources/index.html" title="mod smoldot::sync::all_forks::sources">sources</a></dt><dd>Collection of sources used for the <code>all_forks</code> syncing.</dd></dl><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.AddBlockOccupied.html" title="struct smoldot::sync::all_forks::AddBlockOccupied">AddBlock<wbr>Occupied</a></dt><dd>See <a href="struct.FinishRequest.html#method.add_block" title="method smoldot::sync::all_forks::FinishRequest::add_block"><code>FinishRequest::add_block</code></a> and <a href="enum.AddBlock.html" title="enum smoldot::sync::all_forks::AddBlock"><code>AddBlock</code></a>.</dd><dt><a class="struct" href="struct.AddBlockVacant.html" title="struct smoldot::sync::all_forks::AddBlockVacant">AddBlock<wbr>Vacant</a></dt><dd>See <a href="struct.FinishRequest.html#method.add_block" title="method smoldot::sync::all_forks::FinishRequest::add_block"><code>FinishRequest::add_block</code></a> and <a href="enum.AddBlock.html" title="enum smoldot::sync::all_forks::AddBlock"><code>AddBlock</code></a>.</dd><dt><a class="struct" href="struct.AddSourceKnown.html" title="struct smoldot::sync::all_forks::AddSourceKnown">AddSource<wbr>Known</a></dt><dd>See <a href="enum.AddSource.html" title="enum smoldot::sync::all_forks::AddSource"><code>AddSource</code></a> and <a href="struct.AllForksSync.html#method.prepare_add_source" title="method smoldot::sync::all_forks::AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</dd><dt><a class="struct" href="struct.AddSourceOldBlock.html" title="struct smoldot::sync::all_forks::AddSourceOldBlock">AddSource<wbr>OldBlock</a></dt><dd>See <a href="enum.AddSource.html" title="enum smoldot::sync::all_forks::AddSource"><code>AddSource</code></a> and <a href="struct.AllForksSync.html#method.prepare_add_source" title="method smoldot::sync::all_forks::AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</dd><dt><a class="struct" href="struct.AddSourceUnknown.html" title="struct smoldot::sync::all_forks::AddSourceUnknown">AddSource<wbr>Unknown</a></dt><dd>See <a href="enum.AddSource.html" title="enum smoldot::sync::all_forks::AddSource"><code>AddSource</code></a> and <a href="struct.AllForksSync.html#method.prepare_add_source" title="method smoldot::sync::all_forks::AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</dd><dt><a class="struct" href="struct.AllForksSync.html" title="struct smoldot::sync::all_forks::AllForksSync">AllForks<wbr>Sync</a></dt><dt><a class="struct" href="struct.AnnouncedBlockKnown.html" title="struct smoldot::sync::all_forks::AnnouncedBlockKnown">Announced<wbr>Block<wbr>Known</a></dt><dd>See <a href="enum.BlockAnnounceOutcome.html" title="enum smoldot::sync::all_forks::BlockAnnounceOutcome"><code>BlockAnnounceOutcome</code></a> and <a href="struct.AllForksSync.html#method.block_announce" title="method smoldot::sync::all_forks::AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</dd><dt><a class="struct" href="struct.AnnouncedBlockUnknown.html" title="struct smoldot::sync::all_forks::AnnouncedBlockUnknown">Announced<wbr>Block<wbr>Unknown</a></dt><dd>See <a href="enum.BlockAnnounceOutcome.html" title="enum smoldot::sync::all_forks::BlockAnnounceOutcome"><code>BlockAnnounceOutcome</code></a> and <a href="struct.AllForksSync.html#method.block_announce" title="method smoldot::sync::all_forks::AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</dd><dt><a class="struct" href="struct.BlockVerify.html" title="struct smoldot::sync::all_forks::BlockVerify">Block<wbr>Verify</a></dt><dd>Block verification to be performed.</dd><dt><a class="struct" href="struct.Config.html" title="struct smoldot::sync::all_forks::Config">Config</a></dt><dd>Configuration for the <a href="struct.AllForksSync.html" title="struct smoldot::sync::all_forks::AllForksSync"><code>AllForksSync</code></a>.</dd><dt><a class="struct" href="struct.FinalityProofVerify.html" title="struct smoldot::sync::all_forks::FinalityProofVerify">Finality<wbr>Proof<wbr>Verify</a></dt><dd>Finality proof verification to be performed.</dd><dt><a class="struct" href="struct.FinishRequest.html" title="struct smoldot::sync::all_forks::FinishRequest">Finish<wbr>Request</a></dt><dd>See <a href="struct.AllForksSync.html#method.finish_request" title="method smoldot::sync::all_forks::AllForksSync::finish_request"><code>AllForksSync::finish_request</code></a>.</dd><dt><a class="struct" href="struct.HeaderVerifySuccess.html" title="struct smoldot::sync::all_forks::HeaderVerifySuccess">Header<wbr>Verify<wbr>Success</a></dt><dd>Header verification successful.</dd><dt><a class="struct" href="struct.RemovedBlock.html" title="struct smoldot::sync::all_forks::RemovedBlock">Removed<wbr>Block</a></dt><dd>See <a href="enum.FinalityProofVerifyOutcome.html" title="enum smoldot::sync::all_forks::FinalityProofVerifyOutcome"><code>FinalityProofVerifyOutcome</code></a>.</dd><dt><a class="struct" href="struct.RequestId.html" title="struct smoldot::sync::all_forks::RequestId">Request<wbr>Id</a></dt><dd>Identifier for a request in the <a href="struct.AllForksSync.html" title="struct smoldot::sync::all_forks::AllForksSync"><code>super::AllForksSync</code></a>.</dd><dt><a class="struct" href="struct.RequestParams.html" title="struct smoldot::sync::all_forks::RequestParams">Request<wbr>Params</a></dt><dd>Information about a blocks request to be performed on a source.</dd></dl><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><dl class="item-table"><dt><a class="enum" href="enum.AddBlock.html" title="enum smoldot::sync::all_forks::AddBlock">AddBlock</a></dt><dd>Result of calling <a href="struct.FinishRequest.html#method.add_block" title="method smoldot::sync::all_forks::FinishRequest::add_block"><code>FinishRequest::add_block</code></a>.</dd><dt><a class="enum" href="enum.AddSource.html" title="enum smoldot::sync::all_forks::AddSource">AddSource</a></dt><dd>Outcome of calling <a href="struct.AllForksSync.html#method.prepare_add_source" title="method smoldot::sync::all_forks::AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</dd><dt><a class="enum" href="enum.AncestrySearchResponseError.html" title="enum smoldot::sync::all_forks::AncestrySearchResponseError">Ancestry<wbr>Search<wbr>Response<wbr>Error</a></dt><dd>Error when adding a block using <a href="struct.FinishRequest.html#method.add_block" title="method smoldot::sync::all_forks::FinishRequest::add_block"><code>FinishRequest::add_block</code></a>.</dd><dt><a class="enum" href="enum.BlockAnnounceOutcome.html" title="enum smoldot::sync::all_forks::BlockAnnounceOutcome">Block<wbr>Announce<wbr>Outcome</a></dt><dd>Outcome of calling <a href="struct.AllForksSync.html#method.block_announce" title="method smoldot::sync::all_forks::AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</dd><dt><a class="enum" href="enum.FinalityProofVerifyOutcome.html" title="enum smoldot::sync::all_forks::FinalityProofVerifyOutcome">Finality<wbr>Proof<wbr>Verify<wbr>Outcome</a></dt><dd>Information about the outcome of verifying a finality proof.</dd><dt><a class="enum" href="enum.GrandpaCommitMessageOutcome.html" title="enum smoldot::sync::all_forks::GrandpaCommitMessageOutcome">Grandpa<wbr>Commit<wbr>Message<wbr>Outcome</a></dt><dd>See <a href="struct.AllForksSync.html#method.grandpa_commit_message" title="method smoldot::sync::all_forks::AllForksSync::grandpa_commit_message"><code>AllForksSync::grandpa_commit_message</code></a>.</dd><dt><a class="enum" href="enum.HeaderVerifyError.html" title="enum smoldot::sync::all_forks::HeaderVerifyError">Header<wbr>Verify<wbr>Error</a></dt><dd>Error that can happen when verifying a block header.</dd><dt><a class="enum" href="enum.HeaderVerifyOutcome.html" title="enum smoldot::sync::all_forks::HeaderVerifyOutcome">Header<wbr>Verify<wbr>Outcome</a></dt><dd>Outcome of calling <a href="struct.BlockVerify.html#method.verify_header" title="method smoldot::sync::all_forks::BlockVerify::verify_header"><code>BlockVerify::verify_header</code></a>.</dd><dt><a class="enum" href="enum.ProcessOne.html" title="enum smoldot::sync::all_forks::ProcessOne">Process<wbr>One</a></dt><dd>State of the processing of blocks.</dd></dl></section></div></main></body></html>